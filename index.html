<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

	<title>PHP 7.4: The new hotness</title>

	<link rel="stylesheet" href="css/reset.css" />
	<link rel="stylesheet" href="css/reveal.css" />
<!--	<link rel="stylesheet" href="css/theme/black.css">-->

  <link rel="stylesheet" href="platform/platformsh.css" />

	<!-- Theme used for syntax highlighting of code -->
	<link rel="stylesheet" href="lib/css/monokai.css">

	<!-- Printing and PDF exports -->
	<script>
		var link = document.createElement( 'link' );
		link.rel = 'stylesheet';
		link.type = 'text/css';
		link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
		document.getElementsByTagName( 'head' )[0].appendChild( link );
	</script>

</head>
<body class="skin-blue">
<div class="reveal">
  <footer>
    <img class="logo" src="platform/logos/platformsh-logo-black.svg" alt="Platform.sh" />
    <span class="name">@Crell</span>
  </footer>
	<div class="slides">
    <section class="title">
      <h1>PHP 7.4</h1>
      <h2>The New Hotness</h2>
    </section>
    <section id="presenter">
      <h2>Larry Garfield</h2>
      <h2><a href="https://twitter.com/Crell">@Crell</a></h2>
      <div class="layout-col vcentered">
        <img src="assets/larry-olaf-hug.jpg" alt="Larry implements Huggable" style="width: 350px; margin: 0" />
        <ul style="text-wrap: none">
          <li>Director of DX, <a href="http://www.platform.sh/">Platform.sh</a></li>
          <li style="margin-top: 1em;">PHP-FIG Core Committee</li>
          <li style="margin-top: 1em;"><code>implements Huggable</code></li>
        </ul>
      </div>
    </section>
    <section>
      <div class="layout-stacked" style="height: 600px">
        <div><img src="assets/php-logo.svg" alt="PHP 7" data-credit="https://commons.wikimedia.org/wiki/File:PHP-logo.svg" /></div>
        <h1>7.4</h1>
      </div>
      <aside class="notes">
        <ul>
          <li>Who's using it yet?</li>
          <li>Biggest PHP release since 7.0</li>
          <li>Top 10 things to expect</li>
        </ul>
      </aside>
    </section>
    <section>
      <section>
        <h1>#1</h1>
      </section>
      <section>
        <h2>Anonymous structs are very bad</h2>
        <pre><code class="php font--24" data-trim data-noescape data-line-numbers>
          $order = [
              'id' => 345,
              'total' => 100.45,
              'skus' => [ 123, '5B3', '987'],
              'canceled' => false,
              'usr' => 8,
          ];
        </code></pre>
        <ul style="margin-top: 1em;">
          <li class="fragment">Is canceled spelled right?</li>
          <li class="fragment">Is usr correct or a typo?</li>
          <li class="fragment">Is user an ID or User object?</li>
          <li class="fragment">Are skus numeric or strings?</li>
          <li class="fragment">Can skus be a single value?</li>
          <li class="fragment">Are there other properties?</li>
          <li class="fragment">What currency is total in?</li>
        </ul>
      </section>
      <section>
        <h3>Named structs are better</h3>
        <pre><code class="php font--24" data-trim data-noescape data-line-numbers>
        class Order {
            public $id;
            public $total;
            public $cancelled = false;
            public $user;
            public $skus = [];
        }
        </code></pre>
        <aside class="notes">
          <ul>
            <li>Know legal values</li>
            <li>UK spelling of "cancelled".</li>
            <li>Not 100% better, but 80%.</li>
            <li>Is $user ID or object?</li>
          </ul>
        </aside>
      </section>
      <section>
        <h3>Typed named structs are best</h3>
        <pre><code class="php font--24" data-trim data-noescape data-line-numbers>
        class Order {
            public string $id;
            public Money $total;
            public bool $cancelled = false;
            public User $user;
            public array $skus = [];
        }
        </code></pre>
        <aside class="notes">
          <ul>
            <li>Oh, ID is a string, not an integer.</li>
            <li>Oh, user is an object. We were wrong before.</li>
            <li>Oh, money is a proper value object, too.</li>
            <li>Could use a list object for $skus.</li>
          </ul>
        </aside>
      </section>
      <section>
        <h3>Typed Properties</h3>
        <ul>
          <li class="fragment">Any valid type except callable/void</li>
          <li class="fragment">Enforced on "set"</li>
          <li class="fragment">Can be nullable: <code>private ?User $user;</code></li>
          <li class="fragment">Obeys strict/weak typing mode</li>
          <li class="fragment">Cannot change in inheritance</li>
          <li class="fragment">All you "self-documenting" people, take note</li>
        </ul>
        <aside class="notes">
          <ul>
            <li>void doesn't make sense</li>
            <li>Callable has odd scoping issues</li>
            <li>Enforcement on set has very slight perf impact (likely not noticeable)</li>
            <li>Covariant and contravariant (read and write), so cannot change on inheritance</li>
          </ul>
        </aside>
      </section>
      <section>
        <h3>Defaults are logical</h3>
        <pre><code class="php font--24" data-trim data-noescape data-line-numbers>
          class Test {
              // Legal default values
              public bool     $a = true;
              public int      $b = 42;
              public float    $c = 42.42;
              public string   $e = "str";
              public array    $f = [1, 2, 3];
              public iterable $g = [1, 2, 3];
              public ?int     $h = null;
              public ?Test    $j = null;

              // These have *no* legal default values
              // so "uninitialized"
              public object   $k;
              public Test     $l;
          }
        </code></pre>
        <aside class="notes">
          <ul>
            <li>Can only be set to null if nullable.</li>
          </ul>
        </aside>
      </section>
      <section>
        <h3>"Uninitialized" behavior</h3>
        <pre><code class="php font--24" data-trim data-noescape data-line-numbers>
          class Product {
            public string $size;
          }

          $p = new Product();

          print ($p->size);
          // Throws TypeError:
          // Typed property Product::$size must not be accessed
          // before initialization
        </code></pre>
        <aside class="notes">
          <ul>
            <li>Not the same as null</li>
            <li>Set initial values in definition, or constructor</li>
            <li>If legit could be empty, make it nullable</li>
            <li>If could be empty, question your data model. (Null is a code smell)</li>
          </ul>
        </aside>
      </section>
      <section>
        <p class="oversize"><q>So when should I use it?</q></p>
        <p class="fragment oversize">Pretty much always</p>
      </section>
    </section>
    <section>
      <section>
        <h1>#2</h1>
      </section>
      <section>
        <pre><code class="php font--24" data-trim data-noescape>
          $username = $username ? $username : 'Anonymous';
        </code></pre>
        <pre class="fragment" style="margin-top: 1em;"><code class="php font--24" data-trim data-noescape>
          $username = $username ?: 'Anonymous';
        </code></pre>
        <p class="fragment bigtext">But what if $username doesn't exist?</p>
        <pre class="fragment" style="margin-top: 1em;"><code class="text font--24" data-trim data-noescape>
          Notice: Undefined variable: username on line 3
        </code></pre>
      </section>
      <section>
        <div class="layout-stacked" style="height: 700px">
          <div>
            <p>Fugly...</p>
            <pre><code class="php font--18" data-trim data-noescape>
              $username = isset($username) && !is_null($username) ? $username : 'Anonymous';
            </code></pre>
          </div>
          <div class="fragment">
            <p>NULL coalesce! (PHP 7.0)</p>
            <pre><code class="php font--20" data-trim data-noescape>
              $username = $username ?? $user->username() ?? 'Anonymous';
            </code></pre>
          </div>
          <div class="fragment">
            <p>NULL coalesce assign! (PHP 7.4)</p>
            <pre><code class="php font--20" data-trim data-noescape>
              $username ??= $user->username() ?? 'Anonymous';
            </code></pre>
          </div>
          <p class="fragment bigtext">?? and ??= check setness, not truthiness</p>
        </div>
      </section>
      <section>
        <p class="oversize"><q>So when should I use it?</q></p>
        <ul class="fragment">
          <li class="oversize">Default values object/array parameters</li>
          <li class="oversize">Anywhere it makes the code prettier</li>
        </ul>
      </section>
    </section>
    <section>
      <section>
        <h1>#3</h1>
      </section>
      <section>
        <h3>How do you combine arrays?</h3>
        <pre><code class="php font--24" data-trim data-noescape data-line-numbers>
          $a1 = [1, 2, 3];
          $a2 = [4, 5, 6];
        </code></pre>
        <pre class="fragment"><code class="php font--24" data-trim data-noescape data-line-numbers>
          $b = $a1 + $a2; // Maybe?
          var_dump($b);
        </code></pre>
        <p class="fragment">Wrong!  Only for all-associative arrays.</p>
        <pre class="fragment"><code class="php font--24" data-trim data-noescape>
          array(3) {
            [0]=>
            int(1)
            [1]=>
            int(2)
            [2]=>
            int(3)
          }
        </code></pre>
        <aside class="notes">
          <ul>
            <li>array addition only assigns on unmatched key</li>
          </ul>
        </aside>
      </section>
      <section>
        <div class="layout-stacked" style="height: 600px">
          <div>
            <h3>Fugly</h3>
            <pre><code class="php font--24" data-trim data-noescape data-line-numbers>
              $a1 = [1, 2, 3];
              $a2 = [4, 5, 6];

              $b = array_merge($a1, $a2);  // Eew.
            </code></pre>
          </div>
          <div class="fragment">
            <h3>Spread!</h3>
            <pre><code class="php font--24" data-trim data-noescape data-line-numbers>
              $a1 = [1, 2, 3];
              $a2 = [4, 5, 6];

              $b = [...$a1, ...$a2];
            </code></pre>
          </div>
        </div>
        <aside class="notes">
          <ul>
            <li>Reads as "enumerate all the values in the array"</li>
            <li>Only works for indexed arrays!</li>
          </ul>
        </aside>
      </section>
      <section>
        <div class="layout-stacked" style="height: 650px">
          <h3>Spread 'em all</h3>
          <pre class="fragment"><code class="php font--24" data-trim data-noescape data-line-numbers>
          function afunc(string $b, User ...$users) : callable
          {
              $params = [$a, $b, ...$users];
              anotherFunc(...$params);
          }
        </code></pre>
          <ul class="fragment">
            <li class="oversize">... in function def: Replaces func_get_args()</li>
            <li>... in function call: Replaces call_user_func_array()</li>
            <li>... in array: Replaces array_merge()</li>
          </ul>
          <p class="fragment oversize">... That's amazing!</p>
        </div>
      </section>
      <section>
        <p class="oversize"><q>So when should I use it?</q></p>
        <p class="fragment oversize">Anytime you would have used array_merge()</p>
      </section>
    </section>
    <section>
      <section>
        <h1>#4</h1>
      </section>
      <section>
        <div class="layout-stacked" style="height: 650px">
          <div>
            <p>Think fast, what number is this?</p>
            <pre><code class="php font--24" data-trim data-noescape data-line-numbers>
              $num = 10000000000000;
            </code></pre>
          </div>
          <div class="fragment">
            <p>How about this?</p>
            <pre><code class="php font--24" data-trim data-noescape data-line-numbers>
              $num = 10_000_000_000_000;
            </code></pre>
          </div>
          <p class="fragment oversize">Compile identically</p>
        </div>
        <aside class="notes">
          <ul>
            <li>10 trillion</li>
          </ul>
        </aside>
      </section>
      <section>
        <h3>Any numeric value</h3>
        <pre><code class="php font--24" data-trim data-noescape data-line-numbers>
          6.674_083e-11; // float
          299_792_458;   // integer
          0xCAFE_F00D;   // hexadecimal
          0b0101_1111;   // binary
          0137_041;      // octal
        </code></pre>
        <aside class="notes">
          <ul>
            <li>Between any two digits</li>
            <li>For readability only</li>
          </ul>
        </aside>
      </section>
      <section>
        <p class="oversize"><q>So when should I use it?</q></p>
        <ul class="fragment oversize">
          <li>Big number constants</li>
          <li>Binary literals</li>
          <li>Hex address literals</li>
        </ul>
      </section>
    </section>
    <section>
      <section>
        <h1>#5</h1>
      </section>
      <section>
        <h2>Full method<br />covariance and contravariance</h2>
      </section>
      <section>
        <img src="assets/confused-cat-whut.jpg" alt="Whut?" class="meme" data-credit="http://astrorhysy.blogspot.com/2011/04/ive-got-me-house.html" />
      </section>
      <section>
        <div class="layout-stacked" style="height: 500px">
          <dl>
            <dt>Covariance</dt>
            <dd>Preserves ordering of types from <em>more specific to more generic</em></dd>
            <dt>Contravariance</dt>
            <dd>Preserves ordering of types from <em>more general to more specific</em></dd>
          </dl>
          <p class="fragment oversize">"Subclasses work in inheritance now"</p>
        </div>
      </section>
      <section>
        <h3>PHP < 7.2</h3>
        <p>Cannot vary method signature at all</p>
        <pre><code class="php font--24" data-trim data-noescape data-line-numbers>
          class User {}
          class Admin extends User {}

          class Product {}
          class TShirt extends Product {}

          class FavoriteFinder {
              public function stuff(Admin $user): Product {}
          }

          class UserFavorite extends FavoriteFinder {
              public function stuff(Admin $user): Product {}
          }
        </code></pre>
      </section>
      <section>
        <h3>PHP 7.2</h3>
        <p>Can <em>add</em> return types and <em>remove</em> param types</p>
        <pre><code class="php font--24" data-trim data-noescape data-line-numbers>
          class User {}
          class Admin extends User {}

          class Product {}
          class TShirt extends Product {}

          class FavoriteFinder {
              public function stuff(Admin $user) {}
          }

          class UserFavorite extends FavoriteFinder {
              public function stuff($user): TShirt {}
          }
        </code></pre>
      </section>
      <section>
        <h3>PHP 7.4</h3>
        <p>Super-types for params, subtypes for returns</p>
        <pre><code class="php font--24" data-trim data-noescape data-line-numbers>
          class User {}
          class Admin extends User {}

          class Product {}
          class TShirt extends Product {}

          class FavoriteFinder {
              public function stuff(Admin $user): Product {}
          }

          class UserFavorite extends FavoriteFinder {
              public function stuff(User $user): TShirt {}
          }
        </code></pre>
      </section>
      <section>
        <div class="layout-stacked" style="height: 650px">
          <div>
            <h3><code>return self</code> now works!</h3>
            <pre><code class="php font--24" data-trim data-noescape data-line-numbers>
              interface AList {
                  public function add($item): self;
              }

              class SpecialList implements AList {
                  public function add($item): self {}
              }
            </code></pre>
          </div>
          <div class="fragment">
            <p>PHP < 7.4</p>
            <code>Fatal error: Declaration of SpecialList::add($item): SpecialList must be compatible with AList::add($item): AList</code>
          </div>
          <p class="oversize fragment">(But wait, <code>return static</code> is coming in PHP 8...)</p>
        </div>
        <aside class="notes">
          <ul>
            <li>Especially nice for fluent interfaces, evolvable value objects</li>
          </ul>
        </aside>
      </section>
      <section>
        <p class="oversize"><q>So when should I use it?</q></p>
        <p class="fragment oversize">Any time you want (especially value objects)!</p>
      </section>
    </section>
    <section>
      <section>
        <h1>#6</h1>
        <aside class="notes">
          <ul>
            <li>Let's talk about serialization...</li>
          </ul>
        </aside>
      </section>
      <section>
        <img src="assets/cereal.jpg" alt="Bowl of cereal" data-credit="https://www.flickr.com/photos/vandinglewop/8060703503/" />
      </section>
      <section>
        <h3><code>__sleep</code>/<code>__wakeup</code> (The before times)</h3>
        <pre><code class="php font--18" data-trim data-noescape data-line-numbers>
          class User {
              protected int $id;
              protected string $name;
              protected DateTime $lastLogin;

              // ...

              public function __sleep() {
                  return ['id', 'name'];
              }

              public function __wakeup() {
                  $this->lastLogin = UserSystem::getLastLogin($this->id);
              }
          }
        </code></pre>
        <pre><code class="php font--18" data-trim data-noescape data-line-numbers>
          $s = serialize(new User());
          print_r($s);

          // O:4:"User":2:{s:5:"*id";i:42;s:7:"*name";s:5:"Larry";}
        </code></pre>
      </section>
      <section>
        <h3><code>__sleep</code>/<code>__wakeup</code></h3>
        <div class="layout-col">
          <div>
            <h3>Done well</h3>
            <ul>
              <li class="fragment">Inheritance works properly</li>
              <li class="fragment">Object references retained</li>
              <li class="fragment">Let's the serializer engine do the hard work</li>
            </ul>
          </div>
          <div>
            <h3 class="fragment">Problems</h3>
            <ul>
              <li class="fragment">Can only serialize existing properties</li>
              <li class="fragment">Cannot control deserialization</li>
            </ul>
          </div>
        </div>
      </section>
      <section>
        <h3><code>Serializable</code> (PHP 5.1)</h3>
        <pre><code class="php font--18" data-trim data-noescape data-line-numbers>
          class User implements Serializable {
              protected int $id;
              protected string $name;
              protected DateTime $lastLogin;

              public function serialize() : string {
                  return serialize(['id' => $this->id, 'name' => $this->name]);
              }

              public function unserialize($serialized) : void {
                  $data = unserialize($serialized);
                  $this->id = $data['id'];
                  $this->name = $data['name'];
                  $this->lastLogin = UserSystem::getLastLogin($this->id);
              }
          }
        </code></pre>
        <pre><code class="php font--18" data-trim data-noescape data-line-numbers>
          $s = serialize(new User());
          print_r($s);

          // C:4:"User":43:{a:2:{s:2:"id";i:42;s:4:"name";s:5:"Larry";}}
        </code></pre>
      </section>
      <section>
        <div class="layout-col">
          <div>
            <h3>Done well</h3>
            <ul>
              <li class="fragment">More flexibility in representation</li>
            </ul>
          </div>
          <div>
            <h3 class="fragment">Problems</h3>
            <ul>
              <li class="fragment">Breaks on circular references</li>
              <li class="fragment">Breaks on inheritance (sometimes)</li>
              <li class="fragment">Opaque serialized value</li>
              <li class="fragment">No guarantee serialized format is <code>serialize()</code>-ish</li>
              <li class="fragment">Breaks up the serializer, no optimizations</li>
            </ul>
          </div>
        </div>
      </section>
      <section>
        <h3><code>__serialize</code>/<code>__unserialize</code> (PHP 7.4)</h3>
        <pre><code class="php font--18" data-trim data-noescape data-line-numbers>
          class User {
              protected int $id;
              protected string $name;
              protected DateTime $lastLogin;

              // ...

              public function __serialize() : array {
                  return ['id' => $this->id, 'name' => $this->name];
              }

              public function unserialize(array $data) : void {
                  $this->id = $data['id'];
                  $this->name = $data['name'];
                  $this->lastLogin = UserSystem::getLastLogin($this->id);
              }
          }
        </code></pre>
        <pre><code class="php font--18" data-trim data-noescape data-line-numbers>
          $s = serialize(new User());
          print_r($s);

          // O:4:"User":2:{s:2:"id";i:42;s:4:"name";s:5:"Larry";}
        </code></pre>
      </section>
      <section>
        <h3><code>__serialize</code>/<code>__unserialize</code></h3>
        <div>
          <h3>Done well</h3>
          <ul>
            <li class="fragment">Inheritance works</li>
            <li class="fragment">Object references retained</li>
            <li class="fragment">Full flexibility for what is serialized</li>
            <li class="fragment">Let's the serializer engine do the hard work</li>
            <li class="fragment">Backward compatible</li>
            <li class="fragment">Identical format to <code>__sleep()</code></li>
            <li class="fragment">Essentially a built-in "normalizer" operation</li>
          </ul>
        </div>
        <div>
          <h3 class="fragment">Problems</h3>
          <ul>
            <li class="fragment">None yet? :-)</li>
          </ul>
        </div>
        <aside class="notes">
          <ul>
            <li>BC because methods ignored on older PHP versions</li>
          </ul>
        </aside>
      </section>
      <section>
        <h3>Presidence</h3>
        <p class=""><code>__serialize()</code> > <code>Serializable</code> > <code>__sleep()</code> > default</p>
        <p class="fragment">O: <code>__unserialize()</code> > <code>__wakeup()</code> > default</p>
        <p class="fragment">C: <code>Serializable</code> > <code>__wakeup()</code> > default</p>
      </section>
      <section>
        <p class="oversize"><q>So when should I use it?</q></p>
        <ul class="fragment">
          <li>Any time you want to serialize an object</li>
          <li>When you need a cheap normalized form</li>
        </ul>
      </section>
    </section>
    <section>
      <section>
        <h1>#7</h1>
      </section>
      <section>
        <h3>This is too verbose</h3>
        <pre><code class="php font--20" data-trim data-noescape data-line-numbers>
          $users = [new User(1), new User(2), new User(3), /* ... */];

          $field = 'first';

          usort($users, function (User $u1, User $u2) use ($field) {
              return $u1->get($field) <=> $u2->get($field);
          });

          $names = array_map(function(User $user) use ($field) {
              return $user->get($field);
          }, $users);
        </code></pre>
        <aside class="notes">
          <ul>
            <li>Anon functions very useful</li>
            <li>Also very verbose</li>
            <li>Manual scope import (like C++)</li>
          </ul>
        </aside>
      </section>
      <section>
        <h3>Now more compact</h3>
        <pre><code class="php font--20" data-trim data-noescape data-line-numbers>
          $users = [new User(1), new User(2), new User(3), /* ... */];

          $field = 'first';

          usort($users, fn($u1, $u2) => $u1->get($field) <=> $u2->get($field));

          $names = array_map(fn(User $user) => $user->get($field), $users);
        </code></pre>
        <aside class="notes">
          <ul>
            <li>Short-lambda / arrow function</li>
            <li>Lambda = CS speak for function</li>
          </ul>
        </aside>
      </section>
      <section>
        <h3>Short-lambda / Arrow function</h3>
        <pre><code class="php font--24" data-trim data-noescape data-line-numbers>
          $func = fn() => *expression*;

          $func = fn($a) => *expression*;

          $func = fn(string $a): string => *expression*;
        </code></pre>
        <ul>
          <li class="fragment">Supports types or not</li>
          <li class="fragment">Single expression only</li>
          <li class="fragment">Auto-capture by value</li>
          <li class="fragment">Is itself a value literal</li>
        </ul>
        <aside class="notes">
          <ul>
            <li>Only for single-expression functions</li>
            <li>More compact way of doing what you could before</li>
            <li>"This is huge for functional programming"</li>
          </ul>
        </aside>
      </section>
      <section>
        <p style="font-size: 6em; font-weight: bold">For Functional Programming</p>
        <aside class="notes">
          <ul>
            <li>FP built on function-is-value</li>
            <li>Much easier to write function as value</li>
            <li>Esp for functions operating on functions</li>
          </ul>
        </aside>
      </section>
      <section>
        <h3>Trivial partial application</h3>
        <pre><code class="php font--20" data-trim data-noescape data-line-numbers>
          function volume(float $x, float $y, float $z): float {
              return $x * $y * $z;
          }
        </code></pre>
        <pre class="fragment"><code class="php font--20" data-trim data-noescape data-line-numbers>
          $x = 5;
          $volumeWithX = function(float $y, float $z) use ($x): float {
              return volume($x, $y, $z);
          }
        </code></pre>
        <pre class="fragment"><code class="php font--20" data-trim data-noescape data-line-numbers>
          $volumeWithX = fn(float $y, float $z): float => volume($x, $y, $z);

          $volumeWithXY = fn(float $z) : float => $volumeWithX(4, $z);
        </code></pre>
        <pre class="fragment"><code class="php font--20" data-trim data-noescape data-line-numbers>
          $volumeForLength = fn(float $y): float => volume(5, $y, 8);
        </code></pre>
      </section>
      <section>
        <h3>The class equivalent</h3>
        <pre class="fragment"><code class="php font--20" data-trim data-noescape data-line-numbers>
          class YVolumizer {
              private float $x;
              private float $z;

              public function __construct(float $x, float $z) {
                  $this->x = $x;
                  $this->z = $z;
              }

              public function __invoke(float $y): float {
                  return $this->x * $y * $this->z;
              }
          }
          $volumizerForLength = new YVolumizer(5, 8);
          print $volumizerForLength(4);
        </code></pre>
        <pre class="fragment"><code class="php font--20" data-trim data-noescape data-line-numbers>
          $volumeForLength = fn(float $y): float => volume(5, $y, 8);
          print $volumeForLength(4);
        </code></pre>
      </section>
      <section>
        <h3>Make any function single-parameter</h3>
        <pre class="fragment"><code class="php font--20" data-trim data-noescape data-line-numbers>
          function compose(callable ...$fns): callable {
              return fn($x)
                => array_reduce($fns, fn($collect, $fn)
                  => $fn($collect), $x);
          }

          $holiday = "Lincoln's Birthday";
          $findPromotionsFor = compose(
              fn($x) => getShoppingList($x, 'wishlist'),
              fn($x) => mostExpensiveItem($x, ['exclude' => 'onSale']),
              fn($x) => getPromotions($x, $holiday),
          );

          $findPromotionsFor($someUser);
        </code></pre>
        <aside class="notes">
          <ul>
            <li>Makes building and assembling tiny components trivial in code</li>
          </ul>
        </aside>
      </section>
      <section>
        <p class="oversize"><q>So when should I use it?</q></p>
        <ul class="fragment">
          <li>Most map/filter/usort calls</li>
          <li>Call function parameters out of order</li>
          <li>"Thinking in functions"</li>
        </ul>
        <aside class="notes">
          <ul>
            <li>My favorite feature</li>
            <li>Will probably take a while for people to get it</li>
          </ul>
        </aside>
      </section>
    </section>
    <section>
      <section>
        <h1>#8</h1>
      </section>
      <section>
        <p class="oversize">Q: <q>What is the slowest, avoidable part of a large app?</q></p>
        <p class="fragment oversize">A: Autoloading</p>
        <aside class="notes">
          <ul>
            <li>All that time reading disk, relinking</li>
            <li>Opcache only avoids recompiling</li>
          </ul>
        </aside>
      </section>
      <section>
        <h3>How PHP Opcache works</h3>
        <img src="assets/php-include.svg" alt="PHP re-links code on every include" />
        <aside class="notes">
          <ul>
            <li>Types and dependencies: Make sure classes actually align to parent/interfaces</li>
          </ul>
        </aside>
      </section>
      <section>
        <h3>How PHP 7.4 Opcache works</h3>
        <img src="assets/php-include-preload.svg" alt="Preloading loads code into shared memory at system startup" />
        <aside class="notes">
          <ul>
            <li>Reloading requires PHP-FPM restart</li>
            <li>No disk IO, no autoload triggered, nothing</li>
            <li>Not always a win; needs benchmarks</li>
          </ul>
        </aside>
      </section>
      <section>
        <div class="layout-stacked" style="height: 650px">
          <div>
            <h3><code>php.ini</code></h3>
            <pre><code class="ini font--20" data-trim data-noescape>
              opcache.preload = preload-script.php
            </code></pre>
          </div>
          <div class="fragment">
            <h3><code>preload-script.php</code></h3>
            <pre><code class="php font--20" data-trim data-noescape data-line-numbers>
            $directory = new RecursiveDirectoryIterator(__DIR__ . '/vendor');
            $iterator = new RecursiveIteratorIterator($directory);
            $regex = new RegexIterator($iterator, '/^.+\.php$/i',
                RecursiveRegexIterator::GET_MATCH);

            foreach ($regex as $key => $file) {
                // This is the important part!
                opcache_compile_file($file[0]);
            }
          </code></pre>
          </div>
        </div>
        <aside class="notes">
          <ul>
            <li>Pre-loads all .php files in vendor</li>
            <li>Not always the best strategy!</li>
            <li>May want more or less</li>
            <li>Does increase shared memory size</li>
            <li>Do your own benchmarks</li>
          </ul>
        </aside>
      </section>
      <section>
        <p class="oversize"><q>So when should I use it?</q></p>
        <ul class="fragment">
          <li>Let benchmarks tell you</li>
          <li>Anything not easily autoloaded (functions)</li>
          <li>I'll probably use it for most code</li>
        </ul>
      </section>
    </section>
    <section>
      <section>
        <h1>#9</h1>
        <aside class="notes">
          <ul>
            <li>This one is tricky and edge case-y</li>
            <li>FFI</li>
          </ul>
        </aside>
      </section>
      <section>
        <img src="assets/australian-water-dragon.jpg" alt="Here be dragons!" data-credit="https://www.flickr.com/photos/merryjack/26151133470/" />
        <aside class="notes">
          <ul>
            <li>Here be dragons...</li>
            <li>Australian water dragon, cute!</li>
          </ul>
        </aside>
      </section>
      <section>
        <h3>Foreign Function Interface</h3>
        <ul>
          <li class="fragment">Expose C ABI code to PHP</li>
          <li class="fragment">Works with any compiled C ABI language (mainly C and Rust)</li>
          <li class="fragment">Kind of a clunky API</li>
          <li class="fragment">Many security considerations</li>
        </ul>
      </section>
      <section>
        <h3><code>points.h</code></h3>
        <pre><code class="c font--20" data-trim data-noescape data-line-numbers>
          struct point {
              int     x;
              int     y;
          };

          double distance(struct point first, struct point second);
        </code></pre>
        <h3><code>points.c</code></h3>
        <pre><code class="c font--20" data-trim data-noescape data-line-numbers>
          #include "points.h"
          #include &lt;math.h&gt;

          double distance(struct point first, struct point second) {
              double a_squared = pow((second.x - first.x), 2);
              double b_squared = pow((second.y - first.y), 2);

              return sqrt(a_squared + b_squared);
          }
        </code></pre>
        <aside class="notes">
          <ul>
            <li>Compile to a .so file.</li>
            <li>Won't go into details for time</li>
          </ul>
        </aside>
      </section>
      <section>
        <h3><code>classes.php</code></h3>
        <pre><code class="php font--20" data-trim data-noescape data-line-numbers>
          class Point {
             public int $x;
             public int $y;

             public function __construct(int $x, int $y) {
                 $this->x = $x;
                 $this->y = $y;
             }
          }
        </code></pre>
        <aside class="notes">
          <ul>
            <li>Not required for FFI, but good practice</li>
          </ul>
        </aside>
      </section>
      <section>
        <h3><code>inline.php</code></h3>
        <pre><code class="php font--20" data-trim data-noescape data-line-numbers>
          require_once 'classes.php';

          $ffi = FFI::cdef(file_get_contents('points.h'), 'points.so');

          $p1 = new Point(3, 4);
          $p2 = new Point(7, 9);

          $cp1 = $ffi->new('struct point');
          $cp2 = $ffi->new('struct point');

          $cp1->x = $p1->x;
          $cp1->y = $p1->y;
          $cp2->x = $p2->x;
          $cp2->y = $p2->y;

          $d = $ffi->distance($cp1, $cp2);

          print "Distance is $d\n";
        </code></pre>
        <aside class="notes">
          <ul>
            <li>cdef() wants definition, which is header file, or fragment thereof</li>
            <li>Note: PHP's header file parser is custom and crap</li>
            <li>Need to define manual file for most libs</li>
          </ul>
        </aside>
      </section>
      <section>
        <div class="layout-stacked" style="height: 600px">
          <pre><code class="bash font--24" data-trim data-noescape data-line-numbers>
            $ php inline.php
            Distance is 6.4031242374328
          </code></pre>
          <h1 class="fragment">:-)</h1>
          <p class="oversize fragment">But this is super slow</p>
          <h1 class="fragment">:-(</h1>
        </div>
      </section>
      <section>
        <h3>FFI performance</h3>
        <ul>
          <li class="fragment">C code is way faster than PHP</li>
          <li class="fragment">Initializing the library on each request is very slow</li>
          <li class="fragment">Calling across the PHP/C boundary is very slow</li>
        </ul>
        <p class="fragment oversize"><em>Running arbitrary C code is stupidly insecure!</em></p>
      </section>
      <section>
        <h3>Preloading FFI</h3>
        <ul>
          <li class="fragment">FFI only works from CLI or in preload code</li>
          <li class="fragment"><code>ffi.enable=true</code> (don't do this in prod!)</li>
          <li class="fragment">Default is <code>preload</code></li>
          <li class="fragment">Preload requires Opcache</li>
          <li class="fragment">Opcache not enabled on CLI by default</li>
        </ul>
      </section>
      <section>
        <h3><code>points.h</code></h3>
        <pre><code class="c font--20" data-trim data-noescape data-line-numbers>
          #define FFI_SCOPE "POINTS"
          #define FFI_LIB "./points.so"

          struct point {
              int     x;
              int     y;
          };

          double distance(struct point first, struct point second);
        </code></pre>
        <h3><code>preloader.php</code></h3>
        <pre><code class="php font--20" data-trim data-noescape data-line-numbers>
          FFI::load(__DIR__ . "/points.h");
          opcache_compile_file(__DIR__ . "/classes.php");
        </code></pre>
        <aside class="notes">
          <ul>
            <li>#defines used by FFI to know what the header file is for</li>
            <li>SCOPE is how PHP will know this lib</li>
            <li>load() parses header file, loads lib into memory once</li>
            <li>Preload the class file while we're at it.</li>
          </ul>
        </aside>
      </section>
      <section>
        <h3><code>preload.php</code></h3>
        <pre><code class="php font--20" data-trim data-noescape data-line-numbers>
          $ffi = \FFI::scope("POINTS");

          $p1 = new Point(3, 4);
          $p2 = new Point(7, 9);

          $cp1 = $ffi->new('struct point');
          $cp2 = $ffi->new('struct point');

          $cp1->x = $p1->x;
          $cp1->y = $p1->y;
          $cp2->x = $p2->x;
          $cp2->y = $p2->y;

          $d = $ffi->distance($cp1, $cp2);

          print "Distance is $d\n";
        </code></pre>
        <aside class="notes">
          <ul>
            <li>scope() gets reference to the lib already in memory</li>
            <li>The rest of the code is the same</li>
          </ul>
        </aside>
      </section>
      <section>
          <pre><code class="bash font--20" data-trim data-noescape data-line-numbers>
            $ php -d opcache.preload="preloader.php" \
                  -d opcache.enable_cli=true \
                  preload.php
            Distance is 6.4031242374328
          </code></pre>
      </section>
      <section>
        <h3>Abstract the API</h3>
        <h3><code>classes.php</code></h3>
        <pre><code class="php font--20" data-trim data-noescape data-line-numbers>
        class Point {
            public int $x;
            public int $y;

            public function __construct(int $x, int $y) {
                $this->x = $x;
                $this->y = $y;
            }

            public function toStruct($ffi) {
                $cp = $ffi->new('struct point');
                $cp->x = $this->x;
                $cp->y = $this->y;
                return $cp;
            }
        }
        </code></pre>
      </section>
      <section>
        <h3>Abstract the API</h3>
        <h3><code>classes.php</code></h3>
        <pre><code class="php font--20" data-trim data-noescape data-line-numbers>
        class PointApi {
            private static $ffi = null;

            public function __construct() {
                static::$ffi ??= \FFI::scope("POINTS");
            }

            public function distance(Point $p1, Point $p2): float {
                $cp1 = $p1->toStruct(static::$ffi);
                $cp2 = $p2->toStruct(static::$ffi);

                return static::$ffi->distance($cp1, $cp2);
            }
        }
        </code></pre>
        <aside class="notes">
          <ul>
            <li>Look, null-coalesce assign!</li>
            <li>$ffi scopes are cheap, safe to reuse</li>
            <li>Hides the FFI from the end user</li>
          </ul>
        </aside>
      </section>
      <section>
        <h3><code>preload.php</code></h3>
        <pre><code class="php font--20" data-trim data-noescape data-line-numbers>
          $p1 = new Point(3, 4);
          $p2 = new Point(7, 9);

          $api = new PointApi();

          $d = $api->distance($p1, $p2);

          print "Distance is $d\n";
        </code></pre>
        <aside class="notes">
          <ul>
            <li>Hide all the fiddly bits</li>
            <li>The API is now super simple</li>
          </ul>
        </aside>
      </section>
      <section>
        <p class="oversize">It works with Rust-based .so files, too!</p>
        <p class="fragment oversize">(Though you'll need a manual header file)</p>
      </section>
      <section>
        <h3>Examples and resources</h3>
        <ul>
          <li><a href="https://platform.sh/blog/2020/php-fun-with-ffi-just-enough-c/">PHPfun with FFI series</a></li>
          <li><a href="https://github.com/platformsh-examples/php-ffi">These examples in C and Rust</a></li>
          <li><a href="https://github.com/gabrielrcouto/awesome-php-ffi">FFI with existing libs</a> from Gabriel Couto</li>
        </ul>
      </section>
      <section>
        <p class="oversize"><q>So when should I use it?</q></p>
        <ul class="fragment">
          <li>Not for everyday use</li>
          <li>When you would have needed an extension</li>
          <li><em>Existing</em> large C libraries you want to use (Machine learning?)</li>
          <li>Very complex self-contained algorithms (Use Rust)</li>
        </ul>
      </section>
    </section>
    <section>
      <section>
        <h1>#10</h1>
      </section>
      <section>
        <p class="oversize">Beware these deprecations/changes</p>
      </section>
      <section>
        <p class="oversize"><code>__toString</code> can now throw Exceptions</p>
        <aside class="notes">
          <ul>
            <li>No reason it shouldn't before, it was just hard</li>
            <li>May impact some error handling tests</li>
          </ul>
        </aside>
      </section>
      <section>
        <p class="oversize"><code>{}</code> for strings and arrays is deprecated</p>
        <p class="oversize fragment">Again...</p>
        <pre class="fragment"><code class="php font--24" data-trim data-noescape data-line-numbers>
          $array = [1, 2];
          echo $array[1]; // prints 2
          echo $array{1}; // also prints 2 - DEPRECATED

          $string = "foo";
          echo $string[0]; // prints "f"
          echo $string{0}; // also prints "f" - DEPRECATED
        </code></pre>
        <aside class="notes">
          <ul>
            <li>Soft-deprecated once, but didn't throw message</li>
            <li>Still work, but will throw deprecation message</li>
          </ul>
        </aside>
      </section>
      <section>
        <p class="oversize">Left-associative ternaries deprecated</p>
        <pre class="fragment"><code class="php font--24" data-trim data-noescape data-line-numbers>
          return $a == 1 ? 'one'
               : $a == 2 ? 'two'
               : $a == 3 ? 'three'
               : $a == 4 ? 'four'
                         : 'other';
        </code></pre>
        <p class="fragment">Does that check <code>$a == 1</code> first, or last?</p>
      </section>
      <section>
        <h3>In PHP 7.3</h3>
        <pre><code class="php font--24" data-trim data-noescape data-line-numbers>
          return ((($a == 1 ? 'one'
               : $a == 2) ? 'two'
               : $a == 3) ? 'three'
               : $a == 4) ? 'four'
                         : 'other';
        </code></pre>
        <p class="fragment"><code>$a == 1</code> prints <code>four</code></p>
        <aside class="notes">
          <ul>
            <li>Every other language is the other way around (more logical)</li>
          </ul>
        </aside>
      </section>
      <section>
        <div class="layout-stacked" style="height: 600px">
          <div>
            <h3>In PHP 7.4</h3>
            <p>Parentheses are required when nested, deprecation warning otherwise</p>
          </div>
          <div class="fragment">
            <h3>In PHP 8.0</h3>
            <p>Parentheses are required when nested, compile error otherwise</p>
          </div>
          <div class="fragment">
            <h3>In all versions</h3>
            <p>What are you doing nesting ternaries like that???</p>
          </div>
          <div class="fragment">
            <p><code>$a ?: $b ?: $c</code> is unchanged</p>
          </div>
        </div>
      </section>
      <section>
        <h3>Concatenation precedence</h3>
        <pre class="fragment"><code class="php font--24" data-trim data-noescape data-line-numbers>
          // How is this interpreted?
          echo "sum: " . $a + $b;

          // PHP 7.3
          echo ("sum: " . $a) + $b;

          // PHP 7.4 (what you probably always meant)
          echo "sum :" . ($a + $b);
        </code></pre>
        <aside class="notes">
          <ul>
            <li>All known cases where this changes behavior are actually bugs to begin with</li>
          </ul>
        </aside>
      </section>
      <section>
        <div class="layout-stacked" style="height:600px">
          <p><code>array_key_exists()</code> with objects is deprecated</p>
          <p class="fragment"><code>implode($pieces, $glue)</code> is deprecated</p>
          <p class="fragment"><code>money_format()</code> is deprecated; use <code>NumberFormatter::formatCurrency()</code></p>
          <p class="fragment"><code>allow_url_include</code> is deprecated</p>
          <p class="fragment"><code>$closure->bindTo(null)</code> is deprecated</p>
          <p class="fragment">array access on non-container throws E_WARNING</p>
        </div>
        <aside class="notes">
          <ul>
            <li>implode() only takes the documented order, or no $glue</li>
            <li>money_format() is buggy</li>
            <li>allow_url_include is a security hole</li>
            <li>Unbinding $this makes closure engine code unsafe</li>
            <li>non-container: int, object, etc. Was always a bug, now get message</li>
          </ul>
        </aside>
      </section>
    </section>
    <section>
      <section>
        <h2>&lt;aside&gt;</h2>
      </section>
      <section>
        <div class="layout-col equal-width">
          <div><img src="assets/nikita-popov.jpg" alt="Nikita Popov" /></div>
          <div class="fragment"><img src="assets/jetbrains-logo.svg" alt="JetBrains" width="300px" data-credit="https://www.jetbrains.com/company/brand/logos/" /></div>
        </div>
        <aside class="notes">
          <ul>
            <li>Long-time core contributor</li>
            <li>Now full time at JetBrains working on PHP engine</li>
            <li>7 / 27 RFCs (25%)</li>
            <li>On company time!</li>
          </ul>
        </aside>
      </section>
      <section>
        <h2>&lt;/aside&gt;</h2>
      </section>
    </section>
    <section>
      <section>
        <div class="layout-stacked" style="height:600px">
          <div>
            <p class="oversize"><q>So when should I use it?</q></p>
            <p class="fragment oversize">Right now!</p>
          </div>
          <p class="fragment"><a href="http://phpversions.info/new-and-shiny/">PHP Versions</a> lists 17 compatible hosts</p>
          <p class="fragment">(Yep, including <a href="https://platform.sh/">Platform.sh</a>)</p>
        </div>
      </section>
    </section>


    <div style="display: none">

      27 RFCs passed. 7 from Nikita

      * Typed Properties
      * Null coalesce assign
      * Array spread
      * Numeric literal separator: 1_000_000
      * Covariant return/contravariant params (return self doesn't suck now)
      * Yet another serialization mechanism
      * Short closures
      * Preloading

      * Weakrefs
      * FFI

      * Exceptions from __toString()

      * Deprecations and changes to prepare for PHP 8
      ** Deprecate {} for array/sring offsets.
      ** Left-associative ternary
      ** Concat precedence

    </div>

    <section id="final">
      <h2>Larry Garfield</h2>
      <h2><a href="http://twitter.com/Crell">@Crell</a></h2>
      <p>Director of Developer Experience <a href="http://www.platform.sh/">Platform.sh</a></p>
      <p>Idea to Cloud Hosting</p>
      <p>Stalk us at <a href="http://twitter.com/Platformsh">@PlatformSH</a></p>
    </section>

	</div>
</div>

<script src="js/reveal.js"></script>

<script>
	// More info about config & dependencies:
	// - https://github.com/hakimel/reveal.js#configuration
	// - https://github.com/hakimel/reveal.js#dependencies
	Reveal.initialize({
    hash: true,
    controlsTutorial: false,
		dependencies: [
			{ src: 'plugin/markdown/marked.js' },
			{ src: 'plugin/markdown/markdown.js' },
			{ src: 'plugin/notes/notes.js', async: true },
			{ src: 'plugin/highlight/highlight.js', async: true }
		]
	});
</script>

<!-- Custom Reveal extension scripts. -->
<script src="platform/classer.js"></script>
<script src="platform/countup.js"></script>
<script src="platform/usecase.js"></script>

</body>
</html>
