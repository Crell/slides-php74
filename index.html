<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

	<title>PHP 7.4: The new hotness</title>

	<link rel="stylesheet" href="css/reset.css" />
	<link rel="stylesheet" href="css/reveal.css" />
<!--	<link rel="stylesheet" href="css/theme/black.css">-->

  <link rel="stylesheet" href="platform/platformsh.css" />

	<!-- Theme used for syntax highlighting of code -->
	<link rel="stylesheet" href="lib/css/monokai.css">

	<!-- Printing and PDF exports -->
	<script>
		var link = document.createElement( 'link' );
		link.rel = 'stylesheet';
		link.type = 'text/css';
		link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
		document.getElementsByTagName( 'head' )[0].appendChild( link );
	</script>

</head>
<body class="skin-blue">
<div class="reveal">
  <footer>
    <img class="logo" src="platform/logos/platformsh-logo-black.svg" alt="Platform.sh" />
    <span class="name">@Crell</span>
  </footer>
	<div class="slides">
    <section class="title">
      <h1>PHP 7.4</h1>
      <h2>The New Hotness</h2>
    </section>
    <section id="presenter">
      <h2>Larry Garfield</h2>
      <h2><a href="https://twitter.com/Crell">@Crell</a></h2>
      <div class="layout-col vcentered">
        <img src="assets/larry-olaf-hug.jpg" alt="Larry implements Huggable" style="width: 350px; margin: 0" />
        <ul style="text-wrap: none">
          <li>Director of DX, <a href="http://www.platform.sh/">Platform.sh</a></li>
          <li style="margin-top: 1em;">PHP-FIG Core Committee</li>
          <li style="margin-top: 1em;"><code>implements Huggable</code></li>
        </ul>
      </div>
    </section>

    <section>
      <section>
        <h1>#1</h1>
      </section>
      <section>
        <h2>Anonymous structs are very bad</h2>
        <pre><code class="php font--24" data-trim data-noescape data-line-numbers>
          $order = [
              'id' => 345,
              'total' => 100.45,
              'skus' => [ 123, '5B3', '987'],
              'canceled' => false,
              'usr' => 8,
          ];
        </code></pre>
        <ul style="margin-top: 1em;">
          <li class="fragment">Is canceled spelled right?</li>
          <li class="fragment">Is usr correct or a typo?</li>
          <li class="fragment">Is user an ID or User object?</li>
          <li class="fragment">Are skus numeric or strings?</li>
          <li class="fragment">Can skus be a single value?</li>
          <li class="fragment">Are there other properties?</li>
          <li class="fragment">What currency is total in?</li>
        </ul>
      </section>
      <section>
        <h3>Named structs are better</h3>
        <pre><code class="php font--24" data-trim data-noescape data-line-numbers>
        class Order {
            public $id;
            public $total;
            public $cancelled = false;
            public $user;
            public $skus = [];
        }
        </code></pre>
        <aside class="notes">
          <ul>
            <li>Know legal values</li>
            <li>UK spelling of "cancelled".</li>
            <li>Not 100% better, but 80%.</li>
            <li>Is $user ID or object?</li>
          </ul>
        </aside>
      </section>
      <section>
        <h3>Typed named structs are best</h3>
        <pre><code class="php font--24" data-trim data-noescape data-line-numbers>
        class Order {
            public string $id;
            public Money $total;
            public bool $cancelled = false;
            public User $user;
            public array $skus = [];
        }
        </code></pre>
        <aside class="notes">
          <ul>
            <li>Oh, ID is a string, not an integer.</li>
            <li>Oh, user is an object. We were wrong before.</li>
            <li>Oh, money is a proper value object, too.</li>
            <li>Could use a list object for $skus.</li>
          </ul>
        </aside>
      </section>
      <section>
        <h3>Typed Properties</h3>
        <ul>
          <li class="fragment">Any valid type except callable/void</li>
          <li class="fragment">Enforced on "set"</li>
          <li class="fragment">Can be nullable: <code>private ?User $user;</code></li>
          <li class="fragment">Obeys strict/weak typing mode</li>
          <li class="fragment">Cannot change in inheritance</li>
          <li class="fragment">All you "self-documenting" people, take note</li>
        </ul>
        <aside class="notes">
          <ul>
            <li>void doesn't make sense</li>
            <li>Callable has odd scoping issues</li>
            <li>Enforcement on set has very slight perf impact (likely not noticeable)</li>
            <li>Covariant and contravariant (read and write), so cannot change on inheritance</li>
          </ul>
        </aside>
      </section>
      <section>
        <h3>Defaults are logical</h3>
        <pre><code class="php font--24" data-trim data-noescape data-line-numbers>
          class Test {
              // Legal default values
              public bool     $a = true;
              public int      $b = 42;
              public float    $c = 42.42;
              public string   $e = "str";
              public array    $f = [1, 2, 3];
              public iterable $g = [1, 2, 3];
              public ?int     $h = null;
              public ?Test    $j = null;

              // These have *no* legal default values
              // so "uninitialized"
              public object   $k;
              public Test     $l;
          }
        </code></pre>
        <aside class="notes">
          <ul>
            <li>Can only be set to null if nullable.</li>
          </ul>
        </aside>
      </section>
      <section>
        <h3>"Uninitialized" behavior</h3>
        <pre><code class="php font--24" data-trim data-noescape data-line-numbers>
          class Product {
            public string $size;
          }

          $p = new Product();

          print ($p->size);
          // Throws TypeError:
          // Typed property Product::$size must not be accessed
          // before initialization
        </code></pre>
        <aside class="notes">
          <ul>
            <li>Not the same as null</li>
            <li>Set initial values in definition, or constructor</li>
            <li>If legit could be empty, make it nullable</li>
            <li>If could be empty, question your data model. (Null is a code smell)</li>
          </ul>
        </aside>
      </section>
      <section>
        <p class="oversize"><q>So when should I use it?</q></p>
        <p class="fragment oversize">Pretty much always</p>
      </section>
    </section>
    <section>
      <section>
        <h1>#2</h1>
      </section>
      <section>
        <pre><code class="php font--24" data-trim data-noescape>
          $username = $username ? $username : 'Anonymous';
        </code></pre>
        <pre class="fragment" style="margin-top: 1em;"><code class="php font--24" data-trim data-noescape>
          $username = $username ?: 'Anonymous';
        </code></pre>
        <p class="fragment bigtext">But what if $username doesn't exist?</p>
        <pre class="fragment" style="margin-top: 1em;"><code class="text font--24" data-trim data-noescape>
          Notice: Undefined variable: username on line 3
        </code></pre>
      </section>
      <section>
        <div class="layout-stacked" style="height: 700px">
          <div>
            <p>Fugly...</p>
            <pre><code class="php font--18" data-trim data-noescape>
              $username = isset($username) && !is_null($username) ? $username : 'Anonymous';
            </code></pre>
          </div>
          <div class="fragment">
            <p>NULL coalesce! (PHP 7.0)</p>
            <pre><code class="php font--20" data-trim data-noescape>
              $username = $username ?? $user->username() ?? 'Anonymous';
            </code></pre>
          </div>
          <div class="fragment">
            <p>NULL coalesce assign! (PHP 7.4)</p>
            <pre><code class="php font--20" data-trim data-noescape>
              $username ??= $user->username() ?? 'Anonymous';
            </code></pre>
          </div>
          <p class="fragment bigtext">?? and ??= check setness, not truthiness</p>
        </div>
      </section>
      <section>
        <p class="oversize"><q>So when should I use it?</q></p>
        <ul class="fragment">
          <li class="oversize">Default values object/array parameters</li>
          <li class="oversize">Anywhere it makes the code prettier</li>
        </ul>
      </section>
    </section>
    <section>
      <section>
        <h1>#3</h1>
      </section>
      <section>
        <h3>How do you combine arrays?</h3>
        <pre><code class="php font--24" data-trim data-noescape data-line-numbers>
          $a1 = [1, 2, 3];
          $a2 = [4, 5, 6];
        </code></pre>
        <pre class="fragment"><code class="php font--24" data-trim data-noescape data-line-numbers>
          $b = $a1 + $a2; // Maybe?
          var_dump($b);
        </code></pre>
        <p class="fragment">Wrong!  Only for all-associative arrays.</p>
        <pre class="fragment"><code class="php font--24" data-trim data-noescape>
          array(3) {
            [0]=>
            int(1)
            [1]=>
            int(2)
            [2]=>
            int(3)
          }
        </code></pre>
        <aside class="notes">
          <ul>
            <li>array addition only assigns on unmatched key</li>
          </ul>
        </aside>
      </section>
      <section>
        <div class="layout-stacked" style="height: 600px">
          <div>
            <h3>Fugly</h3>
            <pre><code class="php font--24" data-trim data-noescape data-line-numbers>
              $a1 = [1, 2, 3];
              $a2 = [4, 5, 6];

              $b = array_merge($a1, $a2);  // Eew.
            </code></pre>
          </div>
          <div class="fragment">
            <h3>Spread!</h3>
            <pre><code class="php font--24" data-trim data-noescape data-line-numbers>
              $a1 = [1, 2, 3];
              $a2 = [4, 5, 6];

              $b = [...$a1, ...$a2];
            </code></pre>
          </div>
        </div>
        <aside class="notes">
          <ul>
            <li>Reads as "enumerate all the values in the array"</li>
            <li>Only works for indexed arrays!</li>
          </ul>
        </aside>
      </section>
      <section>
        <div class="layout-stacked" style="height: 650px">
          <h3>Spread 'em all</h3>
          <pre class="fragment"><code class="php font--24" data-trim data-noescape data-line-numbers>
          function afunc(string $b, User ...$users) : callable
          {
              $params = [$a, $b, ...$users];
              anotherFunc(...$params);
          }
        </code></pre>
          <ul class="fragment">
            <li class="oversize">... in function def: Replaces func_get_args()</li>
            <li>... in function call: Replaces call_user_func_array()</li>
            <li>... in array: Replaces array_merge()</li>
          </ul>
          <p class="fragment oversize">... That's amazing!</p>
        </div>
      </section>
      <section>
        <p class="oversize"><q>So when should I use it?</q></p>
        <p class="fragment oversize">Anytime you would have used array_merge()</p>
      </section>
    </section>
    <section>
      <section>
        <h1>#4</h1>
      </section>
      <section>
        <div class="layout-stacked" style="height: 650px">
          <div>
            <p>Think fast, what number is this?</p>
            <pre><code class="php font--24" data-trim data-noescape data-line-numbers>
              $num = 10000000000000;
            </code></pre>
          </div>
          <div class="fragment">
            <p>How about this?</p>
            <pre><code class="php font--24" data-trim data-noescape data-line-numbers>
              $num = 10_000_000_000_000;
            </code></pre>
          </div>
          <p class="fragment oversize">Compile identically</p>
        </div>
        <aside class="notes">
          <ul>
            <li>10 trillion</li>
          </ul>
        </aside>
      </section>
      <section>
        <h3>Any numeric value</h3>
        <pre><code class="php font--24" data-trim data-noescape data-line-numbers>
          6.674_083e-11; // float
          299_792_458;   // integer
          0xCAFE_F00D;   // hexadecimal
          0b0101_1111;   // binary
          0137_041;      // octal
        </code></pre>
        <aside class="notes">
          <ul>
            <li>Between any two digits</li>
            <li>For readability only</li>
          </ul>
        </aside>
      </section>
      <section>
        <p class="oversize"><q>So when should I use it?</q></p>
        <ul class="fragment oversize">
          <li>Big number constants</li>
          <li>Binary literals</li>
          <li>Hex address literals</li>
        </ul>
      </section>
    </section>
    <section>
      <section>
        <h1>#5</h1>
      </section>
      <section>
        <h2>Full method<br />covariance and contravariance</h2>
      </section>
      <section>
        <img src="assets/confused-cat-whut.jpg" alt="Whut?" class="meme" data-credit="http://astrorhysy.blogspot.com/2011/04/ive-got-me-house.html" />
      </section>
      <section>
        <div class="layout-stacked" style="height: 500px">
          <dl>
            <dt>Covariance</dt>
            <dd>Preserves ordering of types from <em>more specific to more generic</em></dd>
            <dt>Contravariance</dt>
            <dd>Preserves ordering of types from <em>more general to more specific</em></dd>
          </dl>
          <p class="fragment oversize">"Subclasses work in inheritance now"</p>
        </div>
      </section>
      <section>
        <h3>PHP < 7.2</h3>
        <p>Cannot vary method signature at all</p>
        <pre><code class="php font--24" data-trim data-noescape data-line-numbers>
          class User {}
          class Admin extends User {}

          class Product {}
          class TShirt extends Product {}

          class FavoriteFinder {
              public function stuff(Admin $user): Product {}
          }

          class UserFavorite extends FavoriteFinder {
              public function stuff(Admin $user): Product {}
          }
        </code></pre>
      </section>
      <section>
        <h3>PHP 7.2</h3>
        <p>Can <em>add</em> return types and <em>remove</em> param types</p>
        <pre><code class="php font--24" data-trim data-noescape data-line-numbers>
          class User {}
          class Admin extends User {}

          class Product {}
          class TShirt extends Product {}

          class FavoriteFinder {
              public function stuff(Admin $user) {}
          }

          class UserFavorite extends FavoriteFinder {
              public function stuff($user): TShirt {}
          }
        </code></pre>
      </section>
      <section>
        <h3>PHP 7.4</h3>
        <p>Super-types for params, subtypes for returns</p>
        <pre><code class="php font--24" data-trim data-noescape data-line-numbers>
          class User {}
          class Admin extends User {}

          class Product {}
          class TShirt extends Product {}

          class FavoriteFinder {
              public function stuff(Admin $user): Product {}
          }

          class UserFavorite extends FavoriteFinder {
              public function stuff(User $user): TShirt {}
          }
        </code></pre>
      </section>
      <section>
        <div class="layout-stacked" style="height: 650px">
          <div>
            <h3><code>return self</code> now works!</h3>
            <pre><code class="php font--24" data-trim data-noescape data-line-numbers>
              interface AList {
                  public function add($item): self;
              }

              class SpecialList implements AList {
                  public function add($item): self {}
              }
            </code></pre>
          </div>
          <div class="fragment">
            <p>PHP < 7.4</p>
            <code>Fatal error: Declaration of SpecialList::add($item): SpecialList must be compatible with AList::add($item): AList</code>
          </div>
          <p class="oversize fragment">(But wait, <code>return static</code> is coming in PHP 8...)</p>
        </div>
        <aside class="notes">
          <ul>
            <li>Especially nice for fluent interfaces, evolvable value objects</li>
          </ul>
        </aside>
      </section>
      <section>
        <p class="oversize"><q>So when should I use it?</q></p>
        <p class="fragment oversize">Any time you want (especially value objects)!</p>
      </section>
    </section>
    <section>
      <section>
        <h1>#6</h1>
        <aside class="notes">
          <ul>
            <li>Let's talk about serialization...</li>
          </ul>
        </aside>
      </section>
      <section>
        <img src="assets/cereal.jpg" alt="Bowl of cereal" data-credit="https://www.flickr.com/photos/vandinglewop/8060703503/" />
      </section>
      <section>
        <h3><code>__sleep</code>/<code>__wakeup</code> (The before times)</h3>
        <pre><code class="php font--18" data-trim data-noescape data-line-numbers>
          class User {
              protected int $id;
              protected string $name;
              protected DateTime $lastLogin;

              // ...

              public function __sleep() {
                  return ['id', 'name'];
              }

              public function __wakeup() {
                  $this->lastLogin = UserSystem::getLastLogin($this->id);
              }
          }
        </code></pre>
        <pre><code class="php font--18" data-trim data-noescape data-line-numbers>
          $s = serialize(new User());
          print_r($s);

          // O:4:"User":2:{s:5:"*id";i:42;s:7:"*name";s:5:"Larry";}
        </code></pre>
      </section>
      <section>
        <h3><code>__sleep</code>/<code>__wakeup</code></h3>
        <div class="layout-col">
          <div>
            <h3>Done well</h3>
            <ul>
              <li class="fragment">Inheritance works properly</li>
              <li class="fragment">Object references retained</li>
              <li class="fragment">Let's the serializer engine do the hard work</li>
            </ul>
          </div>
          <div>
            <h3 class="fragment">Problems</h3>
            <ul>
              <li class="fragment">Can only serialize existing properties</li>
              <li class="fragment">Cannot control deserialization</li>
            </ul>
          </div>
        </div>
      </section>
      <section>
        <h3><code>Serializable</code> (PHP 5.1)</h3>
        <pre><code class="php font--18" data-trim data-noescape data-line-numbers>
          class User implements Serializable {
              protected int $id;
              protected string $name;
              protected DateTime $lastLogin;

              public function serialize() : string {
                  return serialize(['id' => $this->id, 'name' => $this->name]);
              }

              public function unserialize($serialized) : void {
                  $data = unserialize($serialized);
                  $this->id = $data['id'];
                  $this->name = $data['name'];
                  $this->lastLogin = UserSystem::getLastLogin($this->id);
              }
          }
        </code></pre>
        <pre><code class="php font--18" data-trim data-noescape data-line-numbers>
          $s = serialize(new User());
          print_r($s);

          // C:4:"User":43:{a:2:{s:2:"id";i:42;s:4:"name";s:5:"Larry";}}
        </code></pre>
      </section>
      <section>
        <div class="layout-col">
          <div>
            <h3>Done well</h3>
            <ul>
              <li class="fragment">More flexibility in representation</li>
            </ul>
          </div>
          <div>
            <h3 class="fragment">Problems</h3>
            <ul>
              <li class="fragment">Breaks on circular references</li>
              <li class="fragment">Breaks on inheritance (sometimes)</li>
              <li class="fragment">Opaque serialized value</li>
              <li class="fragment">No guarantee serialized format is <code>serialize()</code>-ish</li>
              <li class="fragment">Breaks up the serializer, no optimizations</li>
            </ul>
          </div>
        </div>
      </section>
      <section>
        <h3><code>__serialize</code>/<code>__unserialize</code> (PHP 7.4)</h3>
        <pre><code class="php font--18" data-trim data-noescape data-line-numbers>
          class User {
              protected int $id;
              protected string $name;
              protected DateTime $lastLogin;

              // ...

              public function __serialize() : array {
                  return ['id' => $this->id, 'name' => $this->name];
              }

              public function unserialize(array $data) : void {
                  $this->id = $data['id'];
                  $this->name = $data['name'];
                  $this->lastLogin = UserSystem::getLastLogin($this->id);
              }
          }
        </code></pre>
        <pre><code class="php font--18" data-trim data-noescape data-line-numbers>
          $s = serialize(new User());
          print_r($s);

          // O:4:"User":2:{s:2:"id";i:42;s:4:"name";s:5:"Larry";}
        </code></pre>
      </section>
      <section>
        <h3><code>__serialize</code>/<code>__unserialize</code></h3>
        <div>
          <h3>Done well</h3>
          <ul>
            <li class="fragment">Inheritance works</li>
            <li class="fragment">Object references retained</li>
            <li class="fragment">Full flexibility for what is serialized</li>
            <li class="fragment">Let's the serializer engine do the hard work</li>
            <li class="fragment">Backward compatible</li>
            <li class="fragment">Identical format to <code>__sleep()</code></li>
            <li class="fragment">Essentially a built-in "normalizer" operation</li>
          </ul>
        </div>
        <div>
          <h3 class="fragment">Problems</h3>
          <ul>
            <li class="fragment">None yet? :-)</li>
          </ul>
        </div>
        <aside class="notes">
          <ul>
            <li>BC because methods ignored on older PHP versions</li>
          </ul>
        </aside>
      </section>
      <section>
        <h3>Presidence</h3>
        <p class=""><code>__serialize()</code> > <code>Serializable</code> > <code>__sleep()</code> > default</p>
        <p class="fragment">O: <code>__unserialize()</code> > <code>__wakeup()</code> > default</p>
        <p class="fragment">C: <code>Serializable</code> > <code>__wakeup()</code> > default</p>
      </section>
      <section>
        <p class="oversize"><q>So when should I use it?</q></p>
        <ul class="fragment">
          <li>Any time you want to serialize an object</li>
          <li>When you need a cheap normalized form</li>
        </ul>
      </section>
    </section>



    <div style="display: none">

      * Typed Properties
      * Null coalesce assign
      * Array spread
      * Numeric literal separator: 1_000_000
      * Covariant return/contravariant params (return self doesn't suck now)
      * Yet another serialization mechanism

      * Weakrefs
      * Short closures
      * Preloading
      * FFI

      * Exceptions from __toString()

      * Deprecations and changes to prepare for PHP 8
      ** Deprecate {} for array/sring offsets.
      ** Left-associative ternary
      ** Concat precedence



    </div>

    <section id="final">
      <h2>Larry Garfield</h2>
      <h2><a href="http://twitter.com/Crell">@Crell</a></h2>
      <p>Director of Developer Experience <a href="http://www.platform.sh/">Platform.sh</a></p>
      <p>Idea to Cloud Hosting</p>
      <p>Stalk us at <a href="http://twitter.com/Platformsh">@PlatformSH</a></p>
    </section>

	</div>
</div>

<script src="js/reveal.js"></script>

<script>
	// More info about config & dependencies:
	// - https://github.com/hakimel/reveal.js#configuration
	// - https://github.com/hakimel/reveal.js#dependencies
	Reveal.initialize({
    hash: true,
    controlsTutorial: false,
		dependencies: [
			{ src: 'plugin/markdown/marked.js' },
			{ src: 'plugin/markdown/markdown.js' },
			{ src: 'plugin/notes/notes.js', async: true },
			{ src: 'plugin/highlight/highlight.js', async: true }
		]
	});
</script>

<!-- Custom Reveal extension scripts. -->
<script src="platform/classer.js"></script>
<script src="platform/countup.js"></script>
<script src="platform/usecase.js"></script>

</body>
</html>
